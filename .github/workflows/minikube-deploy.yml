name: Minikube Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Start Minikube
      uses: medyagh/setup-minikube@latest

    - name: Verify cluster
      run: kubectl get pods -A

    - name: Build Docker image inside Minikube
      run: |
        eval $(minikube -p minikube docker-env)
        docker build -t cborkar6159/tcs-demo:latest .
        docker images

    - name: Deploy to Minikube
      run: |
        kubectl apply -f k8s/springboot-deployment.yaml
        kubectl apply -f k8s/springboot-service.yaml
        kubectl apply -f k8s/springboot-ingress.yaml
        kubectl wait --for=condition=ready pod -l app=springboot --timeout=60s

    - name: Access service URL
      run: |
        minikube service list
        minikube service springboot-service --url

